# vnctst-audio3 仕様書

これは、vnctst-audio3同様の音源ライブラリを開発したいと思う人の為に、vnctst-audio3の仕様を書き記したものです。


## 用語について

- BGM, BGS, ME, SE : [README.md](README.md) を参照。
    - なお、単に「BGM」と言った場合でも、BGSとMEを含む意味で言っているケースがある(処理の分類としては「BGM/BGS/ME」「SE」の二種に分かれる為)。

- device, (再生)デバイス : 物理的なデバイスではなく、WebAudioやHtmlAudio等(のラッパー層)を指す語。
    - デバイス層は低レベルの機能だけを提供する。提供する機能の詳細は後述。
    - デバイス種別についても後述。これは後から追加が可能。

- audio-source, as, 音源ソース : urlからロードされた音源データ。
  この実体はdeviceによってまちまちだが、単一のmapとして表現される。

- audio-channel, ac, channel, 再生チャンネル : 再生可能なインスタンス。
  この実体もdeviceによってまちまちだが、mapの入ったatomとして表現される。
    - acのインスタンスは、asから生成される。複数個の生成も可能。
    - 別々のacを同時に再生する事で「BGMとSEを同時に鳴らす」ような事を実現する。
      勿論、同一のasから生成した複数のacを多重に再生する事も可能。
    - acは再生後にもう一度再生したり、再生中に巻き戻したり、
      再生パラメータを変更したりできる。


## 要件

- BGM/BGS/MEの再生体系と、SEの再生体系は大きく違う。
    - 詳細は後述するが、BGM系はフェード処理および次の曲の予約管理が必要であり、またSEは同時多重再生(および管理)が必要となる点で違いがある
    - なので、高レベルでは、BGM系とSEの処理は完全に分けた方がよい
    - しかし低レベルでの再生部分については共有できる部分が多い。よって、低レベル部分を「device」層として分離し、BGM系とSEとで共有できるようにする
        - なお、「BGM系とSEとで違うdeviceを使うようにしたい」というニーズがあるという点に注意。

- BGMの再生とMEの再生は同じ一つのインスタンス(ステート)で管理される。BGSはそれとは違う別のインスタンス(ステート)で管理される
    - これによって「BGM(もしくはME)と同時に、BGSを鳴らす」事を実現する
    - ここでは、これを「BGMステート」「BGSステート」と呼ぶ事にする

- BGMステートおよびBGSステートは、以下の機能を持つ
    - フェードアウト
    - 次に再生する曲の予約処理(フェードアウト後に再生する事になる為)

TODO


## 環境固有の要件

- バックグラウンド時に消音してくれる機能があるとより良い

- android版chromeでは、WebAudioの音源ロード(デコード)に異様に時間がかかる問題がある
    - この問題に対しては、「BGM/BGS/MEのみ、WebAudioではなくHtmlAudioでの再生とする」という対策がある
        - SEについてはデータ量が短い事が多い為、WebAudioでも問題ないようだ

- iOS系では「まず最初にタッチ系イベントハンドル内から音を出す処理を行う」必要があり、この処理を行うまでは音の再生は無効化される
    - この処理をここでは「アンロック」と呼ぶ事にする


## BGMの状態遷移

TODO


## ...

TODO



## デバイス種別

- `vnctst.audio3.device.dumb` - コンソール出力のみのダミーデバイス
    - WebAudioもHtmlAudioも利用可能でない場合にこれが採用される。もちろん音は出ない。

- `vnctst.audio3.device.web-audio` - WebAudioラッパ

- `vnctst.audio3.device.html-audio-single` - HtmlAudioラッパ(単チャンネル再生)
    - モバイル環境を想定して、同一SEの多重再生を行わないタイプ。
    - 同一SEの多重再生リクエストがあった際には、先に鳴っていたSEを停止させてから新しいSEを再生させる。違うSEであれば普通に多重再生できる。

- `vnctst.audio3.device.html-audio-multi` - HtmlAudioラッパ(多チャンネル再生)
    - PC環境を想定して、同一SEの多重再生を行うタイプ。
    - 内部で `vnctst.audio3.device.html-audio-single` を再利用している


# 付録

## 筆者による、他の音源ライブラリを試した時の感想

- SoundJS, Howler, Buzz - http://doc.tir.ne.jp/misc/karasumaclj/js-libraries#%E9%9F%B3%E6%BA%90%E5%86%8D%E7%94%9F%E3%83%A9%E3%82%A4%E3%83%96%E3%83%A9%E3%83%AA に書いた(2014年頃の情報だが)

- boombox - https://github.com/CyberAgent/boombox.js - 扱いやすいが、標準では同じSEの連打に対応していない。しかしそれ以外は特に問題なく使える為、旧vnctst-audioの内部デバイス部として利用していた



