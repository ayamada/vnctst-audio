(TODO: `dev`ブランチを作り、開発はそっちでするようにする(`master`ブランチの`README.md`が紹介文やChangeLogも兼ねている為、安易に更新できない為)。`DEVEL.md`もそれに合わせて更新する事)

# vnctst-audio4 インターフェース案

vnctst-audio3 のインターフェースがあまりよくないので、改善した案を考える。


## 仕様変更案

- 「BGS」を廃止する。代わりにBGMも複数チャンネルで管理し、「BGMチャンネル番号を指定しない場合は0番が指定されたものとする」という仕様とする
    - このBGMチャンネル番号は飛び値になる事が考えられるので、vecでの管理ではなく、mapでの管理とした方がよい
        - この場合、BGMチャンネルidは番号に限らず、mapのkeyになれるもの(通常はキーワード)で良い事になる。キーワード指定にした方が良いのでは？
            - BGMチャンネルid省略時のデフォルト値は `:bgm` あたりにする？
            - しかし下手にキーワードにすると余計分かりづらくなるような…「そういう風に使ってもよい」ぐらいの扱いにしておき、標準は数値の方が分かりやすい気もする
                - この場合、BGMチャンネルid省略時のデフォルト値はやっぱり `0` がベストだと思う

- 「ME」を廃止する。代わりに `:oneshot?` 引数でループの有無を指定するようにする

- va3での「音源ファイルは特定ディレクトリにまとめて入っている」前提はよくなかった。任意のpathにある音源ファイルを指定できるようにする
    - va3でのキーワード指定は廃止となる。path文字列での指定のみとする
        - ogg/mp3の自動判定については、path文字列の末尾が「`.*`」なら自動判定とする(つまりpath文字列が `"path/to/music.*"` みたいだったら自動判定)
        - この自動判定には「`autoext`」という名前を付ける
    - va3での汎用`play!`は廃止となる

- マクロによる事前プリロード部分を分離する
    - 前述の対応により、ファイルの設置位置が任意になるので、固定しない方がよい為

- プリロードはBGM/SEの区別を持たない事にする。path文字列をキーとする一つのテーブルで管理する

- `init!` をなくす。代わりに設定項目のsetter/getterを提供する
    - 内部的には`init!`は必要だが、内部でこっそり呼べば済むので表には提供しない

- 音源ファイルのキーワード指定について
    - 基本的に「pathは文字列で指定」という仕様にするのは前述の通り。しかしそれでもキーワードで指定できると簡潔になるのでちょっとうれしい。ので、以下の仕様とする
        - pathにキーワードが指定された場合は以下のように文字列化する
            - `:foo.ogg` → `"foo.ogg"`
            - `:foo/bar` → `"foo/bar.*"`
            - `:foo/bar.ogg` → `"foo/bar.ogg"`
    - 上記の指定方法では「二段以上奥のディレクトリ内の音源を指定できない」という問題があるが、「そういう制約です」という事にする(つまり、このキーワード指定を使いたい場合は二段以上奥のディレクトリに音源ファイルを置くな、という事)
    - プリロード/アンロード等、pathを引数に取る関数はそこそこあるが、それら全てにこの変換対応が必要である点に注意(忘れると同一判定に失敗して謎エラーの原因となる)


## インターフェース案


### BGM用

- `(bgm! path ...)` : BGMを鳴らす
    - `path` : 鳴らしたい音源の相対pathを文字列で指定する。指定必須
        - もし文字列の末尾が「`.*`」だった場合は、デフォルトでは「`.ogg`」もしくは「`.mp3`」のどちらかへと読み替えられる(つまり`"path/to/foo.*"`なら`"path/to/foo.ogg"`のようになる)。もちろん事前に両方のファイルを設置しておく事。これで対応できる拡張子は後述の`set-config!`で変更する事ができる。
        - nilを指定した場合は後述の`stop-bgm!`が実行される(つまりBGMを止める扱いになる)
    - `:channel` : BGMチャンネル番号を指定する。省略時は0。
        - BGMチャンネル番号は、複数のBGMを同時に再生する為のもの。通常は省略して構わない。これは「通常のBGMと同時に環境音(波や風の音など)も再生したい」(つまり旧版およびツクール系での「BGS」相当)というケースの為のもの。
    - `:volume` : ボリューム倍率。省略時は1。
    - `:pitch` : 再生速度倍率。省略時は1。
    - `:pan` : パン値。一番左は`-1`、一番右は`1`。省略時は0。
    - `:oneshot?` : 省略時は`nil`。これが偽値ならループ再生を行う

- `(stop-bgm! channel fade-sec)` : 鳴らしているBGMのフェードアウトを開始し、停止する
    - `channel` : 停止させたいBGMチャンネル番号。省略時は`nil`。ここに`nil`を指定する事で、全BGMチャンネルに対してフェードアウト停止処理を行う。通常は省略して問題ない。
    - `fade-sec` : フェードにかける秒数。ここに0を指定する事で即座に停止する事が可能。省略時はデフォルトでは1。このデフォルト値は後述の`set-config!`で変更可能。

- `(playing-bgm?)` `(playing-bgm? channel)` : 指定したBGMチャンネル番号(省略時は0)が再生中なら真値を返す


### SE用

- `(se! path ...)` : SEを鳴らす。返り値として「SEチャンネルオブジェクト」を返す
    - `path` : 鳴らしたい音源の相対pathを文字列で指定する。指定必須
        - もし文字列の末尾が「`.*`」だった場合は、デフォルトでは「`.ogg`」もしくは「`.mp3`」のどちらかへと読み替えられる(つまり`"path/to/foo.*"`なら`"path/to/foo.ogg"`のようになる)。もちろん事前に両方のファイルを設置しておく事。これで対応できる拡張子は後述の`set-config!`で変更する事ができる。
        - 無指定もしくはnilを指定した場合は何も行われない
    - `:volume` : ボリューム倍率。省略時は1。
    - `:pitch` : 再生速度倍率。省略時は1。
    - `:pan` : パン値。一番左は`-1`、一番右は`1`。省略時は0。

- `(stop-se! channel fade-sec)` : 鳴らしているSEのフェードアウトを開始し、停止する
    - `channel` : 停止させたいSEチャンネルオブジェクト。省略時は`nil`。ここに`nil`を指定する事で、その時点で再生中の全SEチャンネルオブジェクトに対してフェードアウト停止処理を行う。通常は省略して問題ない。
    - `fade-sec` : フェードにかける秒数。ここに0を指定する事で即座に停止する事が可能。省略時はデフォルトでは0。このデフォルト値は後述の`set-config!`で変更可能。

- `(alarm! path ...)` : バックグラウンド時でも鳴らせる版の`se!`。引数および返り値は`se!`と同一


### 他(BGM/SE共通)

- `(set-config! k v)` : 設定項目の値を更新する。`k`には以下を指定可能
    - `:volume-master` : マスターボリューム。初期値は`0.5`
    - `:volume-bgm` : BGMボリューム。初期値は`0.5`
    - `:volume-se` : SEボリューム。初期値は`0.5`
    - `:autoext-list` : `autoext`で対応させる拡張子のリスト(優先順位度順)を指定する。初期値として `["ogg" "mp3"]` がセットされている
        - `["ogg" ["mp3" "audio/mpeg"]]` のような指定も可能(`ogg` `mp3` `m4a`以外の音響ファイルはこの指定方法にする必要がある)
    - `:debug?` : 初期値は`false`。コンソールにデバッグログを出力するかどうか
    - `:dont-stop-on-background?` : 初期値は`false`。タブがバックグラウンドになった際にBGMを一時停止するかどうか
    - `:disable-mobile?` : 初期値は`false`。モバイル環境だと判定した際に音響出力の一切を無効化するかどうか
    - `:disable-webaudio?` : 初期値は`false`。WebAudioでの再生を無効化するかどうか(HtmlAudioのみの再生対応とするかどうか)
    - `:disable-htmlaudio?` : 初期値は`false`。HtmlAudioでの再生を無効化するかどうか(WebAudioのみの再生対応とするかどうか)
    - `:se-chattering-sec` : 同一SEを近いタイムスライスで同時再生して諸問題が発生するのを防ぐ為の閾値。初期値は`0.05`。この機能自体を無効化したい場合は0を指定すればよい
    - `:default-bgm-fade-sec` : `stop-bgm!`を引数省略して実行した時のフェード秒数。初期値は`1`。
    - `:default-se-fade-sec` : `stop-se!`を引数省略して実行した時のフェード秒数。初期値は`0`。

- `(config k)` : 設定項目の値を取得する

- `(can-play-ogg?)` : この環境でoggファイルが再生可能かを真偽値で返す

- `(can-play-mp3?)` : この環境でmp3ファイルが再生可能かを真偽値で返す

- `(can-play-m4a?)` : この環境でm4aファイルが再生可能かを真偽値で返す

- `(can-play? mime)` : 指定したMIMEの音源ファイルが再生可能かを真偽値で返す
    - `mime` : `"audio/ogg"` のようなMIME文字列を指定する

- `(load! path)` : 音響ファイルのプリロードを行う。プリロードせずに再生しようとした場合は内部で勝手にプリロードされてから再生が行われる
    - `path` : `bgm!`や`se!`での指定時と同様に、`.*`へのautoext対応が行われる

- `(unload! path)` : プリロードされた音響ファイルのアンロードを行う

- `(loaded? path)` : 指定した音響ファイルのプリロード処理が終了しているどうかを真偽値で返す。プリロード時にエラーが起こった時も「プリロード処理の実行は終了している」ので真値を返す点に注意

- `(error? path)` : 指定した音響ファイルのプリロード処理がエラーを起こしたかどうかを真偽値で返す。プリロード処理の完了前は常に偽値を返す点に注意

- `terminal-type` : va3と同じ

- `(float->percent f)` : va3と同じ

- `(percent->float p)` : va3と同じ

- `(version)` : va3と同じ。js版のみ


### 一括プリロード

- (TODO: 引数としてコンパイル時の対象ディレクトリとウェブサーバ上での対応ディレクトリを指定し、autoext対応のpathのリストを返すマクロを提供する)
    - ※これはマクロなので、引数には即値(もしくはマクロフェーズで評価可能な値)しか指定する事ができない。要注意

- (TODO: プリロード対象のリストとフック関数を引数に取り、asyncにプリロードを実行している関数を提供する)


